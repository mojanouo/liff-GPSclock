<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{text-align:center;font-family:sans-serif}
button{
 background:#6FD9B2;
 color:black;
 border:none;
 padding:12px 30px;
 border-radius:8px;
 font-size:18px;
 margin-top:15px;
}
button:disabled{background:#ccc}
textarea{
 width:80%;
 height:120px;
 font-size:16px;
 margin-top:10px;
}
#overlay{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.4);
 display:none;
 align-items:center;
 justify-content:center;
 color:white;
 font-size:24px;
}
</style>
</head>

<body>

<h2 id="name"></h2>
<div id="time"></div>
<div id="distance"></div>
<div id="map"></div>

<textarea id="reason" placeholder="您現在位於工廠範圍外，請填寫原因"></textarea><br>

<button id="btn" disabled onclick="clock()">打卡</button>

<div id="overlay">處理中...</div>

<script>

const liffId="2008996338-0gw2Kj6n";
const gasUrl="https://script.google.com/macros/s/AKfycbxg0GBDT-bnRTeHQWbqcV1Dm2R5hM_9tL4D-1qbi_WfyCzkeNVshnP1i84CYMyG41QA/exec";

const factory={lat:24.09889432557895,lng:120.53815663297149};
const R=250;

function dist(a,b,c,d){
 const x=(c-a)*111000;
 const y=(d-b)*111000*Math.cos(a*Math.PI/180);
 return Math.sqrt(x*x+y*y);
}

async function main(){
 await liff.init({liffId});
 const p=await liff.getProfile();
 document.getElementById("name").innerText="你好 "+p.displayName;

 navigator.geolocation.getCurrentPosition(pos=>{
   const lat=pos.coords.latitude;
   const lng=pos.coords.longitude;

   const d=Math.round(dist(lat,lng,factory.lat,factory.lng));
   document.getElementById("distance").innerText="距離中心 "+d+" 公尺";

   document.getElementById("map").innerHTML=
   `<iframe width="100%" height="200" src="https://maps.google.com/maps?q=${lat},${lng}&z=17&output=embed"></iframe>`;

   const inRange=d<=R;
   document.getElementById("btn").disabled=!inRange;

   if(inRange){
     document.getElementById("reason").style.display="none";
   }

   window.clock=async()=>{
     document.getElementById("overlay").style.display="flex";

     await fetch(gasUrl,{
       method:"POST",
       body:JSON.stringify({
         userId:p.userId,
         name:p.displayName,
         lat, lng,
         note:document.getElementById("reason").value||"外出",
         inRange
       })
     });

     const t=new Date().toLocaleTimeString("zh-TW",{hour12:false,hour:"2-digit",minute:"2-digit"});
     alert("打卡完成\n時間 "+t);
     liff.closeWindow();
   };

 },()=>alert("定位失敗"));
}

main();
</script>
</body>
</html>
