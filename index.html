<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{text-align:center;font-family:sans-serif;padding:15px}

#now{font-size:18px;margin-top:5px}

button{
 background:#6FD9B2;
 color:black;
 border:none;
 padding:12px 40px;
 border-radius:10px;
 font-size:18px;
 margin-top:15px;
 display:none;
}

button:disabled{background:#ccc}

textarea{
 width:85%;
 height:120px;
 font-size:16px;
 margin:10px auto;
 display:none;
}

#overlay{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,.4);
 display:none;
 align-items:center;
 justify-content:center;
 color:white;
 font-size:26px;
 z-index:999;
}

#done{
 position:fixed;
 inset:0;
 background:white;
 display:none;
 flex-direction:column;
 align-items:center;
 justify-content:center;
 z-index:1000;
 font-size:26px;
}

#map{margin-top:10px}
</style>
</head>

<body>

<h2 id="name"></h2>
<div id="now"></div>
<div id="distance"></div>
<div id="hint"></div>

<div id="map"></div>

<textarea id="reason" placeholder="您目前位於工廠範圍外，請填寫原因後再進行打卡"></textarea><br>

<button id="btn" disabled>打卡</button>

<div id="overlay">⌛處理中，請稍後...</div>
<div id="done"></div>

<script>

const liffId="2008996338-0gw2Kj6n";
const gasUrl="https://script.google.com/macros/s/AKfycbwPdXi3aMdpKJ0kKv8UM1Aw1C7xaULBzAfzruHBRv9suzJin4aycWG8z0es_tzdDzg2/exec";

const factory={lat:24.09889432557895,lng:120.53815663297149};
const R=250;

function dist(a,b,c,d){
 const x=(c-a)*111000;
 const y=(d-b)*111000*Math.cos(a*Math.PI/180);
 return Math.sqrt(x*x+y*y);
}

function nowTime(){
 return new Date().toLocaleTimeString("zh-TW",{hour12:false,hour:"2-digit",minute:"2-digit"});
}

async function main(){

 await liff.init({liffId});
 const p=await liff.getProfile();

 document.getElementById("name").innerText="你好 "+p.displayName;
 document.getElementById("now").innerText="現在時間是 "+nowTime();
 document.getElementById("hint").innerText="定位中...";

 navigator.geolocation.getCurrentPosition(pos=>{

   const lat=pos.coords.latitude;
   const lng=pos.coords.longitude;

   const d=Math.round(dist(lat,lng,factory.lat,factory.lng));

   document.getElementById("distance").innerText="距離中心 "+d+" 公尺";

   document.getElementById("map").innerHTML=
   `<iframe width="100%" height="200" src="https://maps.google.com/maps?q=${lat},${lng}&z=17&output=embed"></iframe>`;

   const inRange=d<=R;

   const btn=document.getElementById("btn");
   const reason=document.getElementById("reason");

   btn.style.display="inline-block";

   if(inRange){
     document.getElementById("hint").innerText="您位於工廠範圍內";
     btn.disabled=false;
   }else{
     document.getElementById("hint").innerText="您位於工廠範圍外";
     reason.style.display="block";

     reason.addEventListener("input",()=>{
       btn.disabled = reason.value.trim()==="";
     });
   }

   btn.onclick=async()=>{

     document.getElementById("overlay").style.display="flex";

     await fetch(gasUrl,{
       method:"POST",
       body:JSON.stringify({
         userId:p.userId,
         name:p.displayName,
         lat,lng,
         note:reason.value||"外出",
         inRange
       })
     });

     document.getElementById("overlay").style.display="none";

     document.getElementById("done").style.display="flex";
     document.getElementById("done").innerHTML=
     "✅ 打卡完成<br><br>時間 "+nowTime();

     setTimeout(()=>liff.closeWindow(),2000);
   };

 },()=>alert("定位失敗"));

}

main();

</script>
</body>
</html>
