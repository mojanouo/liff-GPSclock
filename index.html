<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

<style>
body{font-family:sans-serif;text-align:center;margin:20px}

button{
width:80%;
padding:15px;
margin:15px auto;
font-size:18px;
border:none;
border-radius:10px;
background:#6FD9B2;
color:#000
}

.hidden{display:none}

#reason{
width:80%;
height:120px;
margin:10px auto;
display:block
}

#loading{
position:fixed;
top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,.4);
color:white;
display:none;
align-items:center;
justify-content:center;
font-size:22px;
z-index:10
}

.row{
border-bottom:1px solid #ccc;
padding:8px
}
</style>
</head>

<body>

<div id="loading">âŒ›è™•ç†ä¸­ï¼Œè«‹ç¨å¾Œ...</div>

<!-- HOME -->
<div id="home">
<h2 id="hello"></h2>
<button onclick="showClock()">ğŸŸ¢ æˆ‘è¦æ‰“å¡</button>
<button onclick="showQuery()">ğŸ“„ æŸ¥è©¢æ‰“å¡ç´€éŒ„</button>
</div>

<!-- CLOCK -->
<div id="clock" class="hidden">
<p id="now"></p>
<div id="map"></div>
<textarea id="reason" placeholder="æ‚¨ç¾åœ¨ä½æ–¼å·¥å» ç¯„åœå¤–ï¼Œè«‹èªªæ˜åŸå› "></textarea>
<button id="clockBtn" onclick="clock()">æ‰“å¡</button>
</div>

<!-- QUERY -->
<div id="query" class="hidden">
<h3 id="qname"></h3>

<select id="month"></select>

<div id="result"></div>
</div>

<script>

const LIFF_ID="2008996338-0gw2Kj6n";
const GAS_CLOCK="https://script.google.com/macros/s/AKfycbw0jFClEdJxqwllwpyGlreyoQdvSxefwBmwS_LvTlY6u0sFd0tdkSaMnC86Kjc7ifEL/exec";
const GAS_QUERY="https://script.google.com/macros/s/AKfycbx7Sxeoi-dlGzm1xociZHFD7599bK5jGdpQveiJVGekI_PBgEeH-GfRWaee5onVW5A0mA/exec";

let profile,lat,lng,inRange=false;

async function start(){

await liff.init({liffId:LIFF_ID});
profile=await liff.getProfile();

document.getElementById("hello").innerText="ä½ å¥½ "+profile.displayName;

}

start();

function showClock(){
home.classList.add("hidden");
clock.classList.remove("hidden");
initClock();
}

function showQuery(){
home.classList.add("hidden");
query.classList.remove("hidden");
loadMonths();
}

function initClock(){

now.innerText="ç¾åœ¨æ™‚é–“ï¼š"+new Date().toLocaleTimeString("zh-TW",{hour:'2-digit',minute:'2-digit'});

navigator.geolocation.getCurrentPosition(p=>{

lat=p.coords.latitude;
lng=p.coords.longitude;

const d=getDistance(lat,lng,24.0988943,120.5381566);
inRange=d<250;

map.innerHTML=`<img width=90% src="https://maps.googleapis.com/maps/api/staticmap?zoom=17&size=400x300&markers=${lat},${lng}">`;

reason.style.display=inRange?"none":"block";
clockBtn.disabled=!inRange;

});

}

function getDistance(a,b,c,d){
const R=6371000;
const x=(c-a)*Math.PI/180;
const y=(d-b)*Math.PI/180;
return Math.sqrt(x*x+y*y)*R;
}

async function clock(){

if(!inRange && !reason.value.trim())return alert("è«‹è¼¸å…¥åŸå› ");

loading.style.display="flex";

await fetch(GAS_CLOCK,{
method:"POST",
body:JSON.stringify({
userId:profile.userId,
name:profile.displayName,
lat,lng,
note:reason.value,
inRange
})
});

loading.style.display="none";

alert("âœ… æ‰“å¡å®Œæˆ\n"+new Date().toLocaleTimeString("zh-TW",{hour:'2-digit',minute:'2-digit'}));

liff.closeWindow();

}

async function loadMonths(){

qname.innerText=profile.displayName;

const res=await fetch(GAS_QUERY+"?uid="+profile.userId);
const data=await res.json();

if(!data.length){
result.innerHTML="æŸ¥ç„¡ç›¸é—œè³‡æ–™";
return;
}

const months=[...new Set(data.map(r=>r.date.substr(0,7)))];

month.innerHTML=months.map(m=>`<option>${m}</option>`).join("");

month.onchange=()=>render(data);

render(data);

}

function render(data){

const m=month.value;

const rows=data.filter(r=>r.date.startsWith(m));

result.innerHTML=rows.map(r=>`
<div class=row>
${r.date}ã€€${r.times.join(" | ")}
</div>
`).join("");

}

</script>
</body>
</html>
